<!DOCTYPE html>
<html>
<head>
	<title>Stocktake</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="style/main.css" type="text/css">
	<link rel="stylesheet" href="style/jquery.mobile-1.0a2.min.css" type="text/css"/>
</head>
<body>
	<div id="home" data-role="page">
		<div data-role="header" data-theme="e"><h1>IKEA Products</h1></div>
		<div data-role="content">
			<ul id="products" data-role="listview"></ul>
		</div>
		<div data-role="footer" data-position="fixed"><h4>Made on a couch</h4></div>
	</div>
	
	<div id="product_page" data-role="page">
		<div data-role="header">
            <h2 id="product_name"></h2>
		</div>
		<div id="product_details" data-role="content"></div>
		<div data-role="footer" data-position="fixed"><h4>Made on a couch</h4></div>
	</div>
</body>
<script src="vendor/couchapp/loader.js"></script>
<script type=text/javascript>
	var productId;
	$db = $.couch.db("products");
	function handleDocumentReady() {         
		$("#product_page").bind( "pagebeforeshow", readProduct );
		refreshproducts();
	}
		
	function refreshproducts() {
		$("#products").empty();
		$db.view("products/products",{ 
		success: function(data) {
			var i;
			var product;
			var name;
			var type;
			var description;
			var price;
			var listItem;
			for( i in data.rows ) {
				product = data.rows[i].value;
				name = product.name;
				type = product.type;
				description = product.description;
				price = product.price;

				listItem = $("<li/>");
				header = "<h2>" + name + "</h2>";
				productLink = $("<a/>", {
                            href: "#product_page",
          					"data-identity": product._id,
                            click: function() {
                                productId = $(this).data("identity");
                            	}
							});
				
				productLink.append( header );
				listItem.append( productLink );
				listItem.append( "<p><strong>" + type + "</strong></p>" );
				listItem.append( "<p>" + description + "</p>" );
				listItem.append( "</li>" );
				$("#products").append( listItem );
			}
			
			$("#products").listview("refresh");
		}
		});
	}
	
	function readProduct() {
	  $("#product_details").children().remove();
	    $db.openDoc( productId,
	          { success: function( data ) {
	                  var name = data.name;
	                  var type = data.type;
	                  var description = data.description;
	                  var html = "<h2>" + name + "</h2>" +
	                                "<p>" + type + "</p>" +
	                                "<p>" + description + "</p>";
	                  $("#product_details").append( html );
	                  $("#product_name").text( name );
	          }
	      });
	}
	
	
	$(document).ready(handleDocumentReady);
</script>
</html>